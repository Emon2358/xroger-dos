name: Build Xroger DOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm dosfstools mtools genisoimage wget unzip p7zip-full qemu-utils

      - name: Download and Convert FreeDOS
        run: |
          # Download FreeDOS
          wget https://www.ibiblio.org/pub/micro/pc-stuff/freedos/files/distributions/1.4/FD14-LiveCD.zip
          
          # Extract ISO
          unzip FD14-LiveCD.zip
          ISO_FILE=$(find . -name "*.iso" -type f)
          
          # Create a raw disk image
          qemu-img create -f raw xroger.hdi 1474560
          
          # Create temporary mount points
          mkdir -p iso_mount
          mkdir -p hdi_mount
          
          # Mount ISO
          sudo mount -o loop "$ISO_FILE" iso_mount
          
          # Format HDI
          mkfs.fat -F 12 -n "XROGER-DOS" xroger.hdi
          
          # Mount HDI
          sudo mount -o loop xroger.hdi hdi_mount
          
          # Copy FreeDOS system files
          sudo cp -r iso_mount/FREEDOS/* hdi_mount/
          
          # Create README
          cat > README.txt << EOF
          XROGER DOS HDDイメージ
          作成日時: 2025-07-18 16:20:42 (UTC)
          作成者: Emon2358

          【注意事項】
          ・このHDDイメージはFreeDOS(98)が起動する状態に設定されています。
          ・作成の段階でHDDのフォーマットのみMS-DOSを使用していますが、
            イメージにはMS-DOSのデータが含まれないため配布に問題ないものとしています。

          【免責事項】
          ・このHDDイメージを利用し発生したいかなる事象も関知いたしません。
          ・すべて自身の責任においてご利用ください。
          ・問い合わせも不可とさせていただきます。
          EOF
          
          sudo cp README.txt hdi_mount/
          
          # Create/modify configuration files
          echo "LASTDRIVE=Z" | sudo tee hdi_mount/CONFIG.SYS
          echo "FILES=40" | sudo tee -a hdi_mount/CONFIG.SYS
          echo "BUFFERS=40" | sudo tee -a hdi_mount/CONFIG.SYS
          echo "SHELL=C:\COMMAND.COM /P /E:512" | sudo tee -a hdi_mount/CONFIG.SYS
          
          echo "@ECHO OFF" | sudo tee hdi_mount/AUTOEXEC.BAT
          echo "PROMPT $P$G" | sudo tee -a hdi_mount/AUTOEXEC.BAT
          echo "PATH C:\;C:\DOS" | sudo tee -a hdi_mount/AUTOEXEC.BAT
          echo "SET TEMP=C:\TEMP" | sudo tee -a hdi_mount/AUTOEXEC.BAT
          echo "MKDIR C:\TEMP" | sudo tee -a hdi_mount/AUTOEXEC.BAT
          echo "CLS" | sudo tee -a hdi_mount/AUTOEXEC.BAT
          echo "ECHO Welcome to XROGER-DOS!" | sudo tee -a hdi_mount/AUTOEXEC.BAT
          
          # Create IPL
          cat > ipl.asm << 'EOF'
          [BITS 16]
          [ORG 0x0]
          
          ; BPB (BIOS Parameter Block)
          jmp short boot_start
          nop
          
          OEMLabel:           db "XROGDOS "  ; 8 bytes
          BytesPerSector:     dw 512
          SectorsPerCluster:  db 1
          ReservedSectors:    dw 1
          NumberOfFATs:       db 2
          RootDirEntries:     dw 224
          TotalSectors:       dw 2880        ; 1.44MB
          MediaDescriptor:    db 0xF0        ; 3.5" 1.44MB floppy
          SectorsPerFAT:      dw 9
          SectorsPerTrack:    dw 18
          NumberOfHeads:      dw 2
          HiddenSectors:      dd 0
          TotalSectorsBig:    dd 0
          DriveNumber:        db 0x80        ; ハードディスクとして認識
          Reserved:           db 0
          ExtBootSignature:   db 0x29
          VolumeID:          dd 0x12345678
          VolumeLabel:        db "XROGER-DOS "  ; 11 bytes
          FileSysType:        db "FAT12   "    ; 8 bytes

          boot_start:
              cli
              mov ax, 0x07C0
              mov ds, ax
              mov es, ax
              mov ax, 0x8000
              mov ss, ax
              mov sp, 0xFFFE
              sti

              ; Initialize PC-98 screen
              mov ah, 0x00
              mov al, 0x00
              int 0x18
              
              ; Reset disk system
              xor ax, ax
              int 0x13
              
              ; Load KERNEL.SYS
              mov ax, 19          ; First data sector
              mov bx, 0x8000      ; Buffer location
              call read_sector
              
              ; Jump to kernel
              jmp 0x0000:0x8000

          read_sector:
              push ax
              push bx
              push cx
              push dx
              
              mov cl, 1           ; Read one sector
              xor ch, ch         ; Cylinder 0
              xor dh, dh         ; Head 0
              mov dl, 0x80        ; Drive number (HDD)
              mov ah, 0x02        ; Read sectors
              int 0x13
              
              pop dx
              pop cx
              pop bx
              pop ax
              ret

          times 510-($-$$) db 0
          dw 0xAA55
          EOF
          
          # Compile IPL
          nasm -f bin -o ipl.bin ipl.asm
          
          # Write IPL to HDI
          dd if=ipl.bin of=xroger.hdi conv=notrunc bs=512 count=1
          
          # Unmount everything
          sudo umount iso_mount
          sudo umount hdi_mount
          
          # Cleanup
          rm -rf iso_mount hdi_mount
          rm -f "$ISO_FILE"
          rm -f FD14-LiveCD.zip
          rm -f ipl.bin
          
          # Debug info
          ls -la
          file xroger.hdi

      - name: Upload HDI file
        uses: actions/upload-artifact@v4
        with:
          name: xroger-dos
          path: |
            xroger.hdi
            README.txt
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/heads/main')
        with:
          files: |
            xroger.hdi
            README.txt
          name: Xroger DOS Release
          body: |
            XROGER DOS HDDイメージ
            作成日時: 2025-07-18 16:20:42 (UTC)
            作成者: Emon2358

            【注意事項】
            ・このHDDイメージはFreeDOS(98)が起動する状態に設定されています。
            ・作成の段階でHDDのフォーマットのみMS-DOSを使用していますが、
              イメージにはMS-DOSのデータが含まれないため配布に問題ないものとしています。

            【免責事項】
            ・このHDDイメージを利用し発生したいかなる事象も関知いたしません。
            ・すべて自身の責任においてご利用ください。
            ・問い合わせも不可とさせていただきます。
          tag_name: v1.0.${{ github.run_number }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
