name: Build Xroger DOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm dosfstools mtools genisoimage

      - name: Create PC-98 IPL and system
        run: |
          # Create README
          cat > README.txt << 'EOF'
          XROGER DOS HDDイメージ
          作成日時: 2025-07-18 01:26:27 (UTC)
          作成者: Emon2358

          【注意事項】
          ・このHDDイメージはFreeDOS(98)が起動する状態に設定されています。
          ・作成の段階でHDDのフォーマットのみMS-DOSを使用していますが、
            イメージにはMS-DOSのデータが含まれないため配布に問題ないものとしています。

          【免責事項】
          ・このHDDイメージを利用し発生したいかなる事象も関知いたしません。
          ・すべて自身の責任においてご利用ください。
          ・問い合わせも不可とさせていただきます。

          EOF

          # Create IPL for FreeDOS(98)
          cat > ipl.asm << 'EOF'
          [BITS 16]
          [ORG 0x0]
          
          ; BPB (BIOS Parameter Block)
          jmp short entry
          nop
          
          db "XROGERDOS"    ; OEM ID (8 bytes)
          dw 512            ; Bytes per sector
          db 1              ; Sectors per cluster
          dw 1              ; Reserved sectors
          db 2              ; Number of FATs
          dw 224           ; Root directory entries
          dw 2880          ; Total sectors (1.44MB)
          db 0xF0          ; Media descriptor
          dw 9             ; Sectors per FAT
          dw 18            ; Sectors per track
          dw 2             ; Number of heads
          dd 0             ; Hidden sectors
          dd 0             ; Total sectors (large)
          db 0             ; Drive number
          db 0             ; Reserved
          db 0x29          ; Extended boot signature
          dd 0xDEADBEEF    ; Volume serial number
          db "XROGER-DOS " ; Volume label (11 bytes)
          db "FAT12   "    ; File system type (8 bytes)
          
          entry:
              ; セットアップ
              cli                     ; 割り込み禁止
              xor ax, ax
              mov ss, ax
              mov sp, 0x7C00
              mov ds, ax
              mov es, ax
              sti                     ; 割り込み許可
          
              ; PC-98固有の初期化
              mov ah, 0x00           ; テキストモード設定
              mov al, 0x00
              int 0x18               ; PC-98 BIOS call
          
              ; 画面クリア
              mov ah, 0x0C           ; 画面クリア
              mov al, 0x00           ; 属性
              int 0x18
          
              ; カーソル位置設定
              mov ah, 0x13
              xor dx, dx            ; DH=row=0, DL=column=0
              int 0x18
          
              ; メッセージ表示
              mov si, welcome_msg
              call print_string
              
              ; FreeDOS(98)のブート処理
              mov ax, 0x0200      ; Read sectors
              mov cx, 1           ; Number of sectors to read
              mov dx, 0x0000      ; Head 0, Drive 0
              mov bx, 0x7C00      ; Load address
              int 0x13           ; BIOS disk service
              
              jc error           ; エラー時の処理
              
              jmp 0x0000:0x7C00  ; FreeDOSのブートセクタにジャンプ
              
          error:
              mov si, error_msg
              call print_string
              jmp $
          
          print_string:
              lodsb                   ; DS:SIからALに1バイト読み込み
              or al, al              ; 終端(0)チェック
              jz .done
              mov ah, 0x0A           ; 文字出力ファンクション
              int 0x18               ; PC-98 BIOS call
              jmp print_string
          .done:
              ret
          
          welcome_msg:
              db 'welcom!!! This is xroger.hdi create by project_evanerd!!', 13, 10
              db 'Starting FreeDOS(98)...', 13, 10, 0
              
          error_msg:
              db 'Error: Failed to load FreeDOS(98)', 13, 10, 0
          
          times 510-($-$$) db 0      ; ブートセクタを510バイトにパディング
          dw 0xAA55                  ; ブートシグネチャ
          EOF
          
          # Assemble IPL
          nasm -f bin -o ipl.bin ipl.asm

      - name: Create HDI image
        run: |
          # Create blank 1.44MB HDI
          dd if=/dev/zero of=xroger.hdi bs=1024 count=1440
          
          # Write IPL
          dd if=ipl.bin of=xroger.hdi conv=notrunc
          
          # Format as FAT12 (FreeDOS compatible)
          mkfs.fat -F 12 -n "XROGER-DOS" xroger.hdi
          
          # Create temporary mount point
          mkdir -p tmp_mount
          
          # Mount the image
          sudo mount -o loop xroger.hdi tmp_mount
          
          # Copy system files and README
          sudo cp README.txt tmp_mount/
          
          # Create basic FreeDOS configuration
          echo "DEVICE=HIMEM.SYS" | sudo tee tmp_mount/CONFIG.SYS
          echo "DEVICE=EMM386.EXE NOEMS" | sudo tee -a tmp_mount/CONFIG.SYS
          echo "FILES=40" | sudo tee -a tmp_mount/CONFIG.SYS
          echo "BUFFERS=40" | sudo tee -a tmp_mount/CONFIG.SYS
          
          echo "@ECHO OFF" | sudo tee tmp_mount/AUTOEXEC.BAT
          echo "PROMPT $P$G" | sudo tee -a tmp_mount/AUTOEXEC.BAT
          echo "PATH C:\BIN;C:\DOS" | sudo tee -a tmp_mount/AUTOEXEC.BAT
          echo "CLS" | sudo tee -a tmp_mount/AUTOEXEC.BAT
          echo "ECHO Welcome to XROGER-DOS with FreeDOS(98)!" | sudo tee -a tmp_mount/AUTOEXEC.BAT
          
          # Unmount
          sudo umount tmp_mount
          rm -rf tmp_mount

      - name: Upload HDI file
        uses: actions/upload-artifact@v4
        with:
          name: xroger-dos
          path: |
            xroger.hdi
            README.txt
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/heads/main')
        with:
          files: |
            xroger.hdi
            README.txt
          name: Xroger DOS Release
          body: |
            XROGER DOS HDDイメージ
            作成日時: 2025-07-18 01:26:27 (UTC)
            作成者: Emon2358

            【注意事項】
            ・このHDDイメージはFreeDOS(98)が起動する状態に設定されています。
            ・作成の段階でHDDのフォーマットのみMS-DOSを使用していますが、
              イメージにはMS-DOSのデータが含まれないため配布に問題ないものとしています。

            【免責事項】
            ・このHDDイメージを利用し発生したいかなる事象も関知いたしません。
            ・すべて自身の責任においてご利用ください。
            ・問い合わせも不可とさせていただきます。
          tag_name: v1.0.${{ github.run_number }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
